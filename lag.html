<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
</head>
<body>
  <i>Credentials:</i><br />
  <label for="username">username:&nbsp;</label><input type="text" id="username">
  <label for="password">password:&nbsp;</label><input type="password" id="password">
  <label for="portal">portal:&nbsp;</label><input type="text" id="portal" style="width:256px" placeholder="https://www.arcgis.com">
  <br /><br />
  milliseconds between uploads: <input type="text" id="lagMs" placeholder="500" maxlength="5" size="4" />
  <br /><br />
  <input type="file" id="files" name="files[]" multiple />
  <br /><br />
  <output id="list"></output>

  <script src="https://requirejs.org/docs/release/2.3.6/minified/require.js"></script>
  <script>
    require.config({
      paths: {
        "@esri/arcgis-rest-auth": "node_modules/@esri/arcgis-rest-auth/dist/umd/auth.umd.min",
        "@esri/arcgis-rest-portal": "node_modules/@esri/arcgis-rest-portal/dist/umd/portal.umd.min",
        "@esri/arcgis-rest-request": "node_modules/@esri/arcgis-rest-request/dist/umd/request.umd.min",
        "@esri/hub-common": "node_modules/@esri/hub-common/dist/umd/common.umd.min"
      }
    });

    require(["@esri/arcgis-rest-auth", "@esri/arcgis-rest-portal", "@esri/hub-common"],
      function (auth, portal, hubCommon) {

        function handleFileSelect(evt) {
          var session = new auth.UserSession({
            username: document.getElementById("username").value,
            password: document.getElementById("password").value,
            portal: (document.getElementById("portal").value || "https://www.arcgis.com") + "/sharing/rest"
          });
          var lagMs = numFromElem('lagMs', 500);
          var files = Array.from(evt.target.files); // FileList object to Array
          var sourceFileCount = files.length;

          let createdItemId = ''
          return createHostItem(session, lagMs)
          .then((id) => {
            createdItemId = id;
            return uploadFiles(files, createdItemId, session);
          })
          .then(() => {
            return portal.getItemResources(createdItemId, {authentication: session});
          })
          .then((response) => {
            // now compare this to the filenames
            document.getElementById('list').innerHTML =
              `Created item ${createdItemId}<br />` +
              `AGO Reports the item has ${response.resources.length} resources, and we uploaded ${sourceFileCount} resources`;
          });
        }

        function numFromElem(elementId, defaultValue) {
          const parsedValue = parseInt(document.getElementById(elementId).value);
          return isNaN(parsedValue) ? defaultValue : parsedValue;
        }

        function createHostItem(session, lagMs) {
          return portal.createItem({
            item: {
              type: 'Web Mapping Application',
              title: `Resource Upload Test - ${lagMs}ms`,
              tags: ['test'],
              typeKeywords: ['resourceTest']
            },
            authentication: session
          })
          .then((resp) => {
            console.log(`Created Host Item ${resp.id}`);
            return resp.id;
          })
          .catch((ex) => {
            console.error(`Error creating hostItem`, ex);
          })
        }

        function uploadFiles (files, itemId, authentication) {
          if (files.length === 0) {
            return Promise.resolve(true);
          } else {
            const file = files.shift();
            const fileOpts = {
              itemId,
              filename: file.name,
              filedata: file
            };
            return uploadResource(fileOpts, authentication)
            .then(() => {
              return uploadFiles(files, itemId, authentication);
            });
          }
        }

        function uploadResource(imgOpts, authentication) {
          console.log(`uploadResource ${imgOpts.filename} to ${imgOpts.itemId}`);
          return portal.addItemResource({
            authentication,
            resource: imgOpts.filedata,
            name: imgOpts.filename,
            id: imgOpts.itemId,
            params: {
              method: 'POST'
            }
          })
          .then((resp) => {
            return _later(1000, resp);
          })
          .then((resp) => {
            console.log(`Added ${imgOpts.filename} to item ${imgOpts.itemId}`);
            return resp;
          })
          .catch(ex => {
            console.log(`Error adding ${imgOpts.filename} to item ${imgOpts.itemId} ::${ex.message} `);
            return {success: false};
          })
        }

        function  _later (delay, value) {
          return new Promise(resolve => setTimeout(resolve, delay, value));
        }

        document.getElementById('files').addEventListener('change', handleFileSelect, false);
      }
    );
  </script>
</body>
</html>
